<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>

 <form name="theForm" action="#" onSubmit="return onSubmit(this);">

  <table>
   <tr>
    <td>
     <input type="submit" name="submit" value="go">
    </td>
   </tr>
   <tr>
    <td>
     send_signal
     <textarea name="send_signal" rows="7" cols="60" >{"key":"value"}</textarea>
    </td>
   </tr>
   <tr>
    <td>
     on_signal
     <textarea name="on_signal" rows="4" cols="60" disabled></textarea>
    </td>
   </tr>
  </table> 

  <div id="helloWorld">HELLO WORLD</div>

  <button name="open" onclick="return onOpen(this);"">Open</button>
  <button name="fullscreen" onclick="return onFullscreen(this);">Open</button>

 </form>

<script type="text/javascript">

let View = {

    recvData : async function(json) {

        let msg = JSON.stringify(json);
        document.theForm.on_signal.value = msg;
        //throw ("new error");
        return "Response: recvData";
    },

    recvFilename : function(fn) {
        document.theForm.on_signal.value = fn;
        return "Response: recvFilename";
    }
};

function onOpen(b) {
    WebKit.Controller.openFile();
    return false;
}

function onSubmit(form)
{
    let msg = document.theForm.send_signal.value;
//    alert(msg);
    let json = JSON.parse(msg);
    form.on_signal.value = "";
   // Model.send_signal("sendData",json);
    //WebKit.Controller.sendData(json);
    WebKit.send_signal("sendData",json)//.then(function(m){alert(m);});
    return false;
}

function onFullscreen()
{
    alert(document.webkitFullscreenEnabled );

    if(document.webkitFullscreenElement)
    {
        document.exitFullscreen();
    }
    else
    {
        let el = document.getElementById("helloWorld");
        alert(el.webkitRequestFullscreen);
        el.webkitRequestFullscreen();
    }
    return false;
}

WebKit.bind(View);

/*
Model.on_signal("recvData", function(json) 
{
    //alert("recvData!!!");
    let msg = JSON.stringify(json);
    //alert(msg);
    document.theForm.on_signal.value = msg;
});
*/
window.onerror=function(e) {
  alert(e.prototype);
  alert(e);
}

function isAsync(f) {
    let a = Object.getPrototypeOf(async function(){}).constructor;
    return f.constructor == a;
}
document.write(Object.getPrototypeOf(async function(){}).constructor);
document.write("recvData: " + isAsync(View.recvData) + "<br>" );
document.write("recvData: " + isAsync(View.recvFilename) + "<br>" );
</script>
</body>
</html>

