<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script src="js/diff2html.min.js"></script> 
  <script src="js/d3.v5.min.js"></script>
<!--  <script src="js/wasm.min.js" type="javascript/worker"></script>
  -->

  <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
  <script src="js/viz.js"></script>
  <script src="js/d3-graphviz.js"></script>
  <link rel="stylesheet" type="text/css" href="css/diff2html.min.css">
  <style type="text/css">

    .scale
    {
        width: calc(100% - 4px);
        height: calc(100% - 6px);
    }

    body {
        background-color: white;
        padding:0px;
        margin:0px;
        height:100%;
    }

    html {
      height:100%;
    }

    div.html {
      border: 1px solid rgb(192, 190, 190);
      margin:2px;
      background-color: white;
    }

    div.main {
      display: flex;
      width:100%;
      height:calc(100% - 36px);
      padding:0px;
    }

    h5 {
      height:36px;
      line-height:36px;
      background-color:#FAFAFA;
      margin:0px;
      padding: 0px 3px;
      vertical-align:bottom;
    }
  </style>
</head>
<body>

  <h5 id="git"></h5>
  <div class="main ">
   <div id="commit">
     commit message:<br>
     <textarea id="commitMsg" rows=5 cols=80></textarea>
     <button id="commitButton">commit</button>
   </div>
   <div id="html" class="html scale">
     <pre id="git"></pre>  
   </div>
  </div>

<script type="text/javascript">


window.onerror = function(e) {
    alert(e);
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
 }


document.addEventListener("DOMContentLoaded", function(e)
{
    let self = {
      dot : "",
      timeout : null,
    };

    let View = {

        setPlainText : function( gitdir,output) {
            if(!output) {
                output = "";
            }
            document.getElementById("commit").style.display = "none";
            document.getElementById("html").innerHTML = "<pre>"  + escapeHtml(output) + "</pre>";
            document.getElementById("git").innerHTML = gitdir;
        },

        render : function() {

              document.getElementById("html").innerHTML = "";

              let height = document.getElementById("html").clientHeight;
              let width = document.getElementById("html").clientWidth;

              d3.select("#html")
              .graphviz()
              .transition(function() {
                return d3.transition().duration(1000);
              })              
              .fit(true)
              .height(height)
              .width(width)
              .onerror(function(e){})
              .renderDot(self.dot);
        },

        setDot : function(headline, dot ) {

          try {            
              self.dot = dot;

              document.getElementById("commit").style.display = "none";
              document.getElementById("git").innerHTML = escapeHtml(headline);

              if ( self.timeout ) {
                clearTimeout(self.timeout);
                self.timeout = setTimeout(function(){ View.render(); }, 500);
              }
              else {
                View.render();
                self.timeout = setTimeout(function(){ }, 1000);
              }
          }
          catch(e) {
            //alert(e);
          }
        },

        setDiff : function( gitdir, output) {

            var diffHtml = window.Diff2Html.html( output, {
                drawFileList: true,
                matching: 'lines',
//                outputFormat: 'side-by-side',
            });

            document.getElementById("commit").style.display = "none";
            document.getElementById("html").innerHTML = diffHtml;
            document.getElementById("git").innerHTML = gitdir;
        },

        setCommit : function( gitdir, output) {

          var diffHtml = window.Diff2Html.html( output, {
            drawFileList: true,
            matching: 'lines',
            //                outputFormat: 'side-by-side',
          });

          document.getElementById("html").innerHTML = diffHtml;
          document.getElementById("commit").style.display = "block";
          document.getElementById("git").innerHTML = gitdir;
        },

        setBranches : function( gitdir, output) {

          let html = "<ul>";
          output.forEach(function(branch)
          {
              html += "<li><a class='branch' href='#' data-branch='"+branch+"'>";
              html += escapeHtml(branch);
              html += "</a></li>"
          });
          html += "</ul>";

          document.getElementById("html").innerHTML = html;
          document.getElementById("commit").style.display = "none";
          document.getElementById("git").innerHTML = gitdir;

          document.querySelectorAll("a.branch").forEach( function(branch) {
              branch.onclick = function(e) {
                e.preventDefault();
                //alert(e.target.getAttribute("data-branch"));
                WebKit.Python.onSelectBranch( e.target.getAttribute("data-branch") );
              };
          });
        },

        onCommit : function() {

          let msg = document.getElementById("commitMsg").value;

          document.getElementById("html").innerHTML = "commit in progress ...";
          document.getElementById("commit").style.display = "none";

          WebKit.Python.onSubmitCommit(msg);
        },

        onResize : function() {

          let height = parseInt((window.innerHeight / 100) * 85);
          //let height = document.getElementById("html").clientHeight;
          let width = document.getElementById("html").clientWidth / 100 * 95;
//                  alert(height.toString()+":"+width);        

//          document.getElementById("git").innerHTML = "" + width + ":" + height;
          View.setDot("" + width + ":" + height, self.dot);
//          document.getElementById("html").style.width = width + "px";
  //        document.getElementById("html").style.height = height + "px";
         // d3.select("svg")
         // .graphviz()
         // .height(height)
         // .width(width); 
        }

    };


    WebKit.bind(View);

    WebKit.Python.onDocumentLoad();
    document.getElementById("commitButton").onclick=View.onCommit;
    window.onresize = View.onResize;
/*
    let g = d3.select("#graph");

    g.html("armageddon");
    let v = g.graphviz({ "useWorker" : false, "useSharedWorker" : false });

          v.logEvents(true)
          .width(400)
          .height(400)
          .onerror(function(e){})
          .dot('digraph {a -> b}')
          .render();
//    alert(d3.select("svg").node().innerHTML);
*/
});

</script>
</body>
</html>

